## 漏洞分析——Mysql 身份认证绕过漏洞（CVE-2012-2122）分析

#### 一、背景介绍

​	此漏洞被收集于网站www.exploit-db.com,漏洞编号为CVE-2012-2122,经杭州汉领信息公司所属汉武实验室评估后，认定其具有一定的研究价值，故由本人对其进行了漏洞验证以及原理分析。

##### 1.1 漏洞描述

​	当连接MariaDB/MySQL时，输入的密码会与期望的正确密码比较，由于不正确的处理，会导致即便是memcmp()返回一个非零值，也会使MySQL认为两个密码是相同的。也就是说只要知道用户名，不断尝试就能够直接登入SQL数据库。

##### 1.2 受影响的数据库版本

​	经查阅相关专业文档，得出受漏洞影响的数据库版本如下：

+ MariaDB versions from 5.1.62, 5.2.12, 5.3.6, 5.5.23 are not.
+ MySQL versions from 5.1.63, 5.5.24, 5.6.6 are not.

##### 1.3 漏洞编号

​	CVE-2012-2122

  

#### 二、漏洞分析

##### 2.1 漏洞的产生原因

​	这个缺陷的根源在于memcmp（）函数总是返回-128到127（有符号字符）范围内的值。也就是说，只有在Linux系统使用SSE优化库(GNU C库)的场合下才能被利用。如果MySQL建立在这样一个系统上，那么源代码会拿用户输入的密码哈希表与数据库中某个特殊账户中存储的哈希表进行比对，有些情形下甚至可以允许输入密码不正确也能通过认证。成功触发这一漏洞的概率约为1：256，MariaDB项目的安全协调人Sergei Golubchik在周六发给oss-sec邮件列表的一封邮件中称。“做300次攻击企图仅需不到一秒的时间，可以说账户密码保护基本上形同虚设。”

​	简而言之，如果您尝试向受此漏洞影响的MySQL服务器进行身份验证，即使提供了错误的密码，也有可能接受您的密码。bash中的以下单行代码将以root用户帐户访问受影响的MySQL服务器，而无需实际知道密码。	

```
$ for i in `seq 1 1000`; do mysql -u root --password=bad -h 127.0.0.1 2>/dev/null; done
```



##### 2.2 漏洞验证

​	实验环境：CentOS7	   mysql版本：5.5.23

​	实验系统用户为本地普通系统用户:

​	运行exp:

![3](assets/3.gif)

##### 2.3 漏洞危害

​	攻击者利用该漏洞可以登录符合此漏洞存在条件的mysql数据库，并进行一系列危险操作。

#### 三、解决方法

​	因为此漏洞出现时间较早，影响版本较早，所以还在使用符合漏洞利用条件的数据库的用户需要升级数据库来避免因此漏洞而产生的损失。